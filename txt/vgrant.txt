# -*- mode: ruby -*-
# vi: set ft=ruby :

Vagrant.configure("2") do |config|
  config.vm.box = "ubuntu/focal64"
  config.vm.box_check_update = false
  
  # Database VM (DB_VM)
  config.vm.define "db_vm", primary: true do |db|
    db.vm.hostname = "db-vm"
    db.vm.network "private_network", ip: "192.168.56.43"
        
    db.vm.provider "virtualbox" do |vb|
      vb.memory = "4096"
      vb.cpus = 2
      vb.name = "DB_VM"
    end
    
    # Database provisioning
    db.vm.provision "shell", inline: <<-SHELL
      # Update system and install MySQL
      sudo apt-get update -y
      sudo apt-get install -y mysql-server
      
      # Configure MySQL to accept connections from private network
      sudo sed -i 's/127.0.0.1/0.0.0.0/' /etc/mysql/mysql.conf.d/mysqld.cnf
      
      # Start and enable MySQL service
      sudo systemctl start mysql
      sudo systemctl enable mysql
      
      # Wait for MySQL to be ready
      sleep 10
      
      # Create database and user
      mysql -u root -e "CREATE DATABASE IF NOT EXISTS #{ENV['DB_NAME'] || 'petclinic'};"
      mysql -u root -e "CREATE USER IF NOT EXISTS '#{ENV['DB_USER'] || 'petuser'}'@'192.168.56.%' IDENTIFIED BY '#{ENV['DB_PASS'] || 'petpass'}';"
      mysql -u root -e "GRANT ALL PRIVILEGES ON #{ENV['DB_NAME'] || 'petclinic'}.* TO '#{ENV['DB_USER'] || 'petuser'}'@'192.168.56.%';"
      mysql -u root -e "FLUSH PRIVILEGES;"
      
      echo "Database setup completed successfully!"
    SHELL
  end

  # Application VM (APP_VM)
  config.vm.define "app_vm" do |app|
    app.vm.hostname = "app-vm"
    app.vm.network "private_network", ip: "192.168.56.44"
    app.vm.network "forwarded_port", guest: 8080, host: 8080
    
    app.vm.provider "virtualbox" do |vb|
      vb.memory = "4096"
      vb.cpus = 2
      vb.name = "APP_VM"
    end
    
    # Application provisioning
    app.vm.provision "shell", inline: <<-SHELL
      # Create application user
      sudo useradd -m -s /bin/bash #{ENV['APP_USER'] || 'appuser'}
      
      # Update system and install dependencies
      sudo apt-get update -y
      sudo apt-get install -y openjdk-11-jdk git
      
      # Switch to application user for remaining setup
      sudo -u #{ENV['APP_USER'] || 'appuser'} bash << 'EOF'
        cd /home/#{ENV['APP_USER'] || 'appuser'}
        
        # Clone the PetClinic repository
        git clone https://gitlab.com/dan-it/groups/devops_soft/-/tree/main/forStep1/PetClinic.git project_dir
        
        cd project_dir
        
        # Make Maven wrapper executable and build application
        chmod +x mvnw
        ./mvnw clean package -DskipTests
        
        # Copy JAR file to app user home directory
        cp target/*.jar /home/#{ENV['APP_USER'] || 'appuser'}/
        
        # Create startup script with environment variables
        cat > /home/#{ENV['APP_USER'] || 'appuser'}/start-app.sh << 'SCRIPT'
        #!/bin/bash
        export DB_HOST=192.168.56.43
        export DB_PORT=3306
        export DB_NAME=#{ENV['DB_NAME'] || 'petclinic'}
        export DB_USER=#{ENV['DB_USER'] || 'petuser'}
        export DB_PASS=#{ENV['DB_PASS'] || 'petpass'}
        
        java -jar /home/#{ENV['APP_USER'] || 'appuser'}/*.jar
        SCRIPT
        
        chmod +x /home/#{ENV['APP_USER'] || 'appuser'}/start-app.sh
      EOF
      
      echo "Application setup completed successfully!"
    SHELL
  end
end